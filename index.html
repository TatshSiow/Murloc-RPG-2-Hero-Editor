<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Murloc RPG 2 Save Scrivener</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.2.0/crypto-js.min.js"></script>
    <script defer src="https://va.vercel-scripts.com/v1/script.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;600;700&family=Roboto+Condensed:wght@300;400;500;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --wow-bg-page: #050408;
            --wow-bg-frame: radial-gradient(circle at top, #151017 0%, #050408 55%, #020107 100%);
            --wow-bg-panel: rgba(10, 6, 2, 0.96);
            --wow-bg-panel-soft: rgba(14, 9, 5, 0.9);
            --wow-bg-subpanel: rgba(5, 3, 2, 0.96);
            --wow-bg-input: rgba(3, 2, 1, 0.98);
            --wow-bg-input-alt: rgba(10, 7, 4, 0.98);
            --wow-bg-button: #261108;
            --wow-bg-button-hover: #4a2410;
            --wow-bg-button-active: #140804;
            --wow-border-gold: #c79a3b;
            --wow-border-gold-soft: rgba(199, 154, 59, 0.52);
            --wow-border-iron: #3b3b3b;
            --wow-border-iron-soft: #252525;
            --wow-border-panel-inner: rgba(255, 255, 255, 0.045);
            --wow-border-highlight: #ffea9a;
            --wow-text-main: #f5e6cc;
            --wow-text-muted: #b8a48a;
            --wow-text-soft: #9b8566;
            --wow-text-danger: #ff4f4f;
            --wow-text-success: #4fff7b;
            --wow-accent-gold: #f8d66d;
            --wow-accent-gold-soft: rgba(248, 214, 109, 0.18);
            --wow-accent-blue: #2ea3ff;
            --wow-accent-red: #bf3131;
            --wow-accent-green: #46c95c;
            --wow-shadow-soft: 0 0 14px rgba(0, 0, 0, 0.95);
            --wow-shadow-strong: 0 0 24px rgba(0, 0, 0, 1);
            --wow-radius-panel: 10px;
            --wow-radius-inner: 7px;
            --wow-radius-slot: 6px;
            --wow-font-heading: 'Cinzel', 'Times New Roman', serif;
            --wow-font-body: 'Roboto Condensed', system-ui, -apple-system, BlinkMacSystemFont, sans-serif;
            --wow-rarity-common: #ffffff;
            --wow-rarity-uncommon: #1eff00;
            --wow-rarity-rare: #0070dd;
            --wow-rarity-epic: #a335ee;
            --wow-rarity-legendary: #ff8000;
        }

        body.wow-page {
            margin: 0;
            min-height: 100vh;
            background: radial-gradient(circle at top, #26120b 0%, #0b0504 40%, #020103 100%);
            color: var(--wow-text-main);
            font-family: var(--wow-font-body);
            letter-spacing: 0.02em;
        }

        .wow-frame {
            max-width: 1280px;
            margin: 32px auto 40px auto;
            padding: 18px 18px 20px 18px;
            background: radial-gradient(circle at top, rgba(210, 180, 90, 0.08) 0%, rgba(4, 2, 1, 0.98) 40%, rgba(0, 0, 0, 0.98) 100%);
            border-radius: 14px;
            border: 2px solid rgba(0, 0, 0, 0.9);
            box-shadow:
                0 0 0 1px rgba(255, 215, 128, 0.08),
                0 0 24px rgba(0, 0, 0, 1),
                0 0 64px rgba(0, 0, 0, 1);
            position: relative;
            overflow: hidden;
        }

        .wow-frame::before,
        .wow-frame::after {
            content: "";
            position: absolute;
            inset: 3px;
            border-radius: 10px;
            pointer-events: none;
        }

        .wow-frame::before {
            border: 1px solid rgba(248, 214, 109, 0.08);
            box-shadow: inset 0 0 18px rgba(0, 0, 0, 0.9);
        }

        .wow-frame::after {
            border: 1px solid rgba(90, 50, 18, 0.65);
            mix-blend-mode: screen;
            opacity: 0.32;
        }

        .wow-header {
            position: relative;
            text-align: center;
            margin: 4px 0 14px 0;
            padding-bottom: 6px;
        }

        .wow-header-title {
            font-family: var(--wow-font-heading);
            font-size: 30px;
            line-height: 1.1;
            text-transform: uppercase;
            letter-spacing: 0.16em;
            color: var(--wow-accent-gold);
            text-shadow:
                0 0 6px rgba(0, 0, 0, 1),
                0 0 14px rgba(0, 0, 0, 1),
                0 0 18px rgba(180, 120, 40, 0.42);
        }

        .wow-header-subtitle {
            margin-top: 4px;
            font-size: 13px;
            color: var(--wow-text-soft);
            text-shadow: 0 0 10px rgba(0, 0, 0, 0.9);
        }

        .wow-header-divider {
            margin: 10px auto 0 auto;
            width: 86%;
            height: 1px;
            background: linear-gradient(
                to right,
                transparent,
                rgba(248, 214, 109, 0.32),
                rgba(248, 214, 109, 0.65),
                rgba(248, 214, 109, 0.32),
                transparent
            );
            box-shadow: 0 0 8px rgba(0, 0, 0, 1);
        }

        .wow-main {
            display: grid;
            grid-template-columns: 3fr 1fr;
            gap: 16px;
            margin-top: 8px;
            position: relative;
            z-index: 1;
        }

        .wow-main-left,
        .wow-main-right {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .wow-main-right {
            align-self: flex-start;
        }

        .wow-panel {
            background: var(--wow-bg-panel);
            border-radius: var(--wow-radius-panel);
            padding: 10px 10px 9px 10px;
            border: 1px solid var(--wow-border-gold-soft);
            box-shadow: var(--wow-shadow-soft);
            position: relative;
        }

        .wow-panel::before {
            content: "";
            position: absolute;
            inset: 1px;
            border-radius: calc(var(--wow-radius-panel) - 1px);
            border: 1px solid rgba(255, 255, 255, 0.02);
            pointer-events: none;
        }

        .wow-subpanel {
            background: var(--wow-bg-subpanel);
            border-radius: var(--wow-radius-inner);
            padding: 7px 8px 7px 8px;
            border: 1px solid var(--wow-border-iron-soft);
            box-shadow: inset 0 0 8px rgba(0, 0, 0, 0.9);
            position: relative;
        }

        .wow-subpanel::before {
            content: "";
            position: absolute;
            inset: 1px;
            border-radius: calc(var(--wow-radius-inner) - 1px);
            border: 1px solid var(--wow-border-panel-inner);
            pointer-events: none;
        }

        .wow-panel-title {
            display: flex;
            align-items: center;
            gap: 6px;
            margin: -2px 0 6px 0;
            font-family: var(--wow-font-heading);
            font-size: 14px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.12em;
            color: var(--wow-accent-gold);
            text-shadow: 0 0 8px rgba(0, 0, 0, 1);
        }

        .wow-panel-title::before,
        .wow-panel-title::after {
            content: "";
            flex: 1;
            height: 1px;
            background: linear-gradient(
                to right,
                transparent,
                rgba(248, 214, 109, 0.36)
            );
            opacity: 0.9;
        }

        .wow-panel-title::after {
            background: linear-gradient(
                to left,
                transparent,
                rgba(248, 214, 109, 0.28)
            );
        }

        .wow-label {
            display: block;
            font-size: 12px;
            font-weight: 500;
            letter-spacing: 0.06em;
            text-transform: uppercase;
            color: var(--wow-text-muted);
            margin-bottom: 4px;
        }

        .wow-input,
        .wow-select {
            width: 100%;
            padding: 5px 7px;
            font-size: 12px;
            border-radius: 4px;
            border: 1px solid var(--wow-border-iron);
            background: var(--wow-bg-input);
            color: var(--wow-text-main);
            outline: none;
            box-shadow: inset 0 0 6px rgba(0, 0, 0, 0.95);
            transition: all 0.14s ease-out;
        }

        .wow-input:focus,
        .wow-select:focus {
            border-color: var(--wow-accent-gold);
            box-shadow:
                0 0 6px rgba(248, 214, 109, 0.35),
                inset 0 0 8px rgba(0, 0, 0, 1);
            background: var(--wow-bg-input-alt);
        }

        .wow-textarea {
            width: 100%;
            min-height: 70px;
            padding: 6px 7px;
            font-size: 11px;
            border-radius: 4px;
            border: 1px solid var(--wow-border-iron);
            background: var(--wow-bg-input);
            color: var(--wow-text-main);
            outline: none;
            resize: vertical;
            font-family: monospace;
            box-shadow: inset 0 0 8px rgba(0, 0, 0, 1);
            transition: all 0.14s ease-out;
        }

        .wow-textarea:focus {
            border-color: var(--wow-accent-gold);
            background: var(--wow-bg-input-alt);
            box-shadow:
                0 0 8px rgba(248, 214, 109, 0.3),
                inset 0 0 10px rgba(0, 0, 0, 1);
        }

        .wow-button {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 4px;
            padding: 7px 14px;
            border-radius: 6px;
            border: 1px solid var(--wow-border-gold-soft);
            background: radial-gradient(circle at 20% 0%, rgba(248, 214, 109, 0.06) 0%, var(--wow-bg-button) 40%, #120703 100%);
            color: var(--wow-accent-gold);
            font-family: var(--wow-font-heading);
            font-size: 14px;
            letter-spacing: 0.11em;
            text-transform: uppercase;
            text-shadow: 0 0 5px rgba(0, 0, 0, 1);
            box-shadow:
                0 0 8px rgba(0, 0, 0, 1),
                inset 0 0 6px rgba(0, 0, 0, 1);
            cursor: pointer;
            transition: all 0.14s ease-out;
        }

        .wow-button:hover {
            background: radial-gradient(circle at 20% 0%, rgba(248, 214, 109, 0.14) 0%, var(--wow-bg-button-hover) 40%, #1b0c05 100%);
            box-shadow:
                0 0 14px rgba(0, 0, 0, 1),
                0 0 16px rgba(248, 214, 109, 0.16);
            transform: translateY(-1px);
        }

        .wow-button:active {
            background: var(--wow-bg-button-active);
            box-shadow:
                0 0 10px rgba(0, 0, 0, 1),
                inset 0 0 10px rgba(0, 0, 0, 1);
            transform: translateY(1px);
        }

        .wow-button-primary {
            background: radial-gradient(circle at 18% 0%, rgba(255, 240, 180, 0.14) 0%, #3a160b 32%, #200804 100%);
            border-color: var(--wow-border-highlight);
            color: var(--wow-accent-gold);
        }

        .wow-button-primary:hover {
            background: radial-gradient(circle at 18% 0%, rgba(255, 240, 180, 0.24) 0%, #4e1d0e 32%, #260a05 100%);
        }

        .wow-button-secondary {
            background: radial-gradient(circle at 18% 0%, rgba(188, 240, 255, 0.12) 0%, #0f2b18 34%, #040906 100%);
            border-color: #6bd492;
            color: #9df3bd;
        }

        .wow-button-secondary:hover {
            background: radial-gradient(circle at 18% 0%, rgba(188, 240, 255, 0.18) 0%, #174227 34%, #050b07 100%);
            box-shadow:
                0 0 14px rgba(0, 0, 0, 1),
                0 0 14px rgba(159, 243, 189, 0.18);
        }

        .hero-summary {
            display: grid;
            grid-template-columns: auto 1fr;
            gap: 10px;
            align-items: center;
            padding: 7px 8px 6px 8px;
            background: linear-gradient(
                    to bottom,
                    rgba(248, 214, 109, 0.04),
                    transparent
                ),
                var(--wow-bg-panel-soft);
            border-radius: var(--wow-radius-panel);
            border: 1px solid rgba(248, 214, 109, 0.2);
            box-shadow:
                0 0 8px rgba(0, 0, 0, 1),
                inset 0 0 10px rgba(0, 0, 0, 0.98);
            margin-bottom: 2px;
        }

        .hero-banner-row {
            display: flex;
            flex-wrap: wrap;
            align-items: center;
            gap: 6px;
            font-size: 11px;
            color: var(--wow-text-soft);
            margin-top: 2px;
        }

        .hero-pill,
        .hero-class-pill,
        .hero-level-pill,
        .hero-xp-pill,
        .hero-location-pill {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 2px 10px;
            border-radius: 999px;
            border: 1px solid rgba(199, 154, 59, 0.38);
            background: radial-gradient(circle at 20% 0%, rgba(248, 214, 109, 0.10), rgba(8, 4, 2, 1));
            box-shadow: 0 0 5px rgba(0, 0, 0, 1);
            color: var(--wow-accent-gold);
            white-space: nowrap;
            font-size: 11px;
        }

        .hero-pill-label {
            text-transform: uppercase;
            letter-spacing: 0.11em;
            font-size: 9px;
            color: var(--wow-text-soft);
        }

        .hero-pill-value {
            color: var(--wow-accent-gold);
        }

        .hero-xp-pill input {
            width: 72px;
            padding: 0;
            border: none;
            background: transparent;
            color: var(--wow-accent-gold);
            font-size: 10px;
            text-align: right;
            outline: none;
        }

        .hero-location-pill span {
            color: var(--wow-accent-gold);
        }

        .hero-location-pill-label {
            text-transform: uppercase;
            letter-spacing: 0.11em;
            font-size: 8px;
            color: var(--wow-text-soft);
        }

        #currentZone {
            position: absolute;
            opacity: 0;
            pointer-events: none;
            height: 0;
            width: 0;
        }

        .hero-level-wrapper {
            display: inline-flex;
            align-items: center;
            gap: 3px;
            margin-right: 4px;
            color: var(--wow-accent-gold);
        }

        .hero-level-pill {
            display: inline-flex;
            align-items: center;
            gap: 3px;
            padding: 1px 7px;
            border-radius: 999px;
            border: 1px solid rgba(199, 154, 59, 0.32);
            background: radial-gradient(circle at 20% 0%, rgba(248, 214, 109, 0.08), rgba(8, 4, 2, 1));
            box-shadow: 0 0 4px rgba(0, 0, 0, 1);
            color: var(--wow-accent-gold);
            white-space: nowrap;
        }

        .hero-level-prefix {
            font-size: 9px;
            text-transform: uppercase;
            letter-spacing: 0.12em;
            color: var(--wow-accent-gold);
        }

        .hero-level-input {
            width: 40px;
            padding: 0;
            border: none;
            background: transparent;
            color: var(--wow-accent-gold);
            font-size: 11px;
            text-align: right;
            outline: none;
        }

        .hero-level-input::-webkit-outer-spin-button,
        .hero-level-input::-webkit-inner-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }

        .hero-level-input[type=number] {
            -moz-appearance: textfield;
        }

        .hero-xp-wrapper {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            margin-top: 2px;
            padding: 1px 6px;
            border-radius: 999px;
            border: 1px solid rgba(199, 154, 59, 0.32);
            background: radial-gradient(circle at 20% 0%, rgba(248, 214, 109, 0.06), rgba(5, 3, 2, 1));
            box-shadow: 0 0 3px rgba(0, 0, 0, 1);
            font-size: 9px;
            color: var(--wow-text-muted);
        }

        .hero-xp-label {
            text-transform: uppercase;
            letter-spacing: 0.12em;
            font-size: 8px;
            color: var(--wow-text-soft);
        }

        .hero-xp-input {
            width: 68px;
            padding: 0;
            border: none;
            background: transparent;
            color: var(--wow-accent-gold);
            font-size: 10px;
            text-align: right;
            outline: none;
        }

        .hero-xp-input::-webkit-outer-spin-button,
        .hero-xp-input::-webkit-inner-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }

        .hero-xp-input[type=number] {
            -moz-appearance: textfield;
        }

        .hero-gold-wrapper {
            display: inline-flex;
            align-items: center;
            flex-wrap: wrap;
            gap: 4px;
            margin-top: 2px;
            padding: 1px 6px;
            border-radius: 999px;
            border: 1px solid rgba(199, 154, 59, 0.32);
            background: radial-gradient(circle at 10% 0%, rgba(248, 214, 109, 0.08), rgba(5, 3, 2, 1));
            box-shadow: 0 0 3px rgba(0, 0, 0, 1);
            font-size: 9px;
            color: var(--wow-text-soft);
        }

        .hero-gold-label {
            text-transform: uppercase;
            letter-spacing: 0.12em;
            font-size: 8px;
            color: var(--wow-text-soft);
            margin-right: 2px;
        }

        .hero-gold-field {
            display: inline-flex;
            align-items: center;
            gap: 2px;
        }

        .hero-gold-input,
        .hero-silver-input,
        .hero-copper-input {
            width: 26px;
            padding: 0;
            border: none;
            background: transparent;
            color: var(--wow-accent-gold);
            font-size: 9px;
            text-align: right;
            outline: none;
        }

        .hero-gold-input::-webkit-outer-spin-button,
        .hero-gold-input::-webkit-inner-spin-button,
        .hero-silver-input::-webkit-outer-spin-button,
        .hero-silver-input::-webkit-inner-spin-button,
        .hero-copper-input::-webkit-outer-spin-button,
        .hero-copper-input::-webkit-inner-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }

        .hero-gold-input[type=number],
        .hero-silver-input[type=number],
        .hero-copper-input[type=number] {
            -moz-appearance: textfield;
        }

        .hero-gold-wrapper .coin {
            width: 0.9em;
            height: 0.9em;
            margin-left: 0;
        }

        .hero-banner-row .hero-level-input {
            width: 40px;
            padding: 0;
            font-size: 11px;
            border: none;
            border-radius: 0;
            background: transparent;
            color: var(--wow-accent-gold);
            text-align: right;
            box-shadow: none;
            outline: none;
        }

        .hero-banner-pill {
            padding: 1px 7px;
            border-radius: 999px;
            border: 1px solid rgba(199, 154, 59, 0.32);
            background: radial-gradient(circle at 20% 0%, rgba(248, 214, 109, 0.08), rgba(8, 4, 2, 1));
            box-shadow: 0 0 4px rgba(0, 0, 0, 1);
            color: var(--wow-accent-gold);
            white-space: nowrap;
        }

        .hero-portrait {
            width: 60px;
            height: 60px;
            border-radius: 6px;
            background:
                radial-gradient(circle at 10% 0%, rgba(248, 214, 109, 0.18), transparent),
                url('https://wow.zamimg.com/uploads/screenshots/normal/55215.jpg') center center / cover no-repeat;
            border: 2px solid var(--wow-border-gold);
            box-shadow:
                0 0 10px rgba(0, 0, 0, 1),
                0 0 10px rgba(248, 214, 109, 0.18);
        }

        .hero-text-block {
            display: flex;
            flex-direction: column;
            gap: 1px;
        }

        .hero-name {
            font-family: var(--wow-font-heading);
            font-size: 16px;
            letter-spacing: 0.12em;
            text-transform: uppercase;
            color: var(--wow-accent-gold);
            text-shadow:
                0 0 6px rgba(0, 0, 0, 1),
                0 0 14px rgba(0, 0, 0, 1);
        }

        .hero-meta {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
            font-size: 10px;
            color: var(--wow-text-soft);
        }

        .hero-meta span {
            padding: 1px 5px;
            border-radius: 999px;
            border: 1px solid rgba(199, 154, 59, 0.3);
            background: radial-gradient(circle at 20% 0%, rgba(248, 214, 109, 0.08), rgba(8, 4, 2, 1));
            box-shadow: 0 0 4px rgba(0, 0, 0, 1);
        }

        .hero-summary-stats {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-top: 2px;
            font-size: 9px;
            color: var(--wow-text-muted);
        }

        .hero-summary-stats span {
            color: var(--wow-accent-gold);
        }

        .stats-panel,
        .quests-panel,
        .equipment-panel,
        .inventory-panel,
        .codex-panel {
            margin-top: 2px;
        }

        .equipment-grid {
            display: grid;
            grid-template-columns: repeat(3, minmax(0, 1fr));
            gap: 8px;
        }

        .wow-slot {
            position: relative;
            padding: 4px 5px;
            border-radius: var(--wow-radius-slot);
            border: 1px solid var(--wow-border-iron-soft);
            background: radial-gradient(circle at 0 0, rgba(248, 214, 109, 0.06), rgba(5, 3, 2, 1));
            box-shadow:
                inset 0 0 8px rgba(0, 0, 0, 1),
                0 0 6px rgba(0, 0, 0, 0.9);
            display: grid;
            grid-template-columns: auto 1fr auto;
            gap: 4px;
            align-items: center;
        }

        .slot-icon {
            width: 40px;
            height: 40px;
            border-radius: 4px;
            background: radial-gradient(circle at 16% 0%, rgba(248, 214, 109, 0.06), rgba(0, 0, 0, 1));
            border: 1px solid var(--wow-border-iron);
            box-shadow:
                0 0 5px rgba(0, 0, 0, 1),
                inset 0 0 6px rgba(0, 0, 0, 1);
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
        }

        .slot-name {
            font-size: 10px;
            line-height: 1.2;
            color: var(--wow-text-main);
            white-space: nowrap;
            text-overflow: ellipsis;
            overflow: hidden;
        }

        .slot-input {
            width: 100%;
            margin-top: 2px;
            font-size: 9px;
            padding: 2px 4px;
            border-radius: 3px;
            background: transparent;
            border: 1px solid transparent;
            color: var(--wow-text-soft);
            outline: none;
        }

        .slot-input:focus {
            border-color: var(--wow-accent-gold);
            background: rgba(6, 4, 3, 1);
            box-shadow: 0 0 6px rgba(0, 0, 0, 1);
        }

        .slot-qty {
            width: 26px;
            font-size: 9px;
            padding: 2px 3px;
            border-radius: 3px;
            background: rgba(6, 3, 2, 1);
            border: 1px solid var(--wow-border-iron);
            color: var(--wow-accent-gold);
            text-align: right;
            outline: none;
            box-shadow: inset 0 0 6px rgba(0, 0, 0, 1);
        }

        .inventory-panel {
            display: flex;
            flex-direction: column;
            gap: 6px;
        }

        .bag-panel {
            margin-top: 3px;
        }

        .codex-panel {
            position: sticky;
            top: 8px;
        }

        .codex-list {
            max-height: 65vh;
            overflow-y: auto;
            padding: 4px;
            border-radius: var(--wow-radius-inner);
            background: var(--wow-bg-subpanel);
            border: 1px solid var(--wow-border-iron-soft);
            box-shadow: inset 0 0 10px rgba(0, 0, 0, 1);
        }

        .codex-list::-webkit-scrollbar {
            width: 7px;
        }

        .codex-list::-webkit-scrollbar-track {
            background: rgba(5, 3, 1, 0.98);
        }

        .codex-list::-webkit-scrollbar-thumb {
            background: rgba(111, 78, 40, 0.85);
            border-radius: 10px;
        }

        .codex-list::-webkit-scrollbar-thumb:hover {
            background: var(--wow-accent-gold);
        }

        .codex-item {
            display: block;
            padding: 3px 5px;
            border-radius: 3px;
            font-size: 10px;
            color: var(--wow-text-main);
            text-decoration: none;
            cursor: pointer;
            transition: all 0.12s ease-out;
        }

        .codex-item:hover {
            background: rgba(248, 214, 109, 0.08);
            box-shadow: 0 0 6px rgba(0, 0, 0, 1);
            transform: translateX(1px);
        }

        .wow-tooltip {
            position: absolute;
            z-index: 100;
            padding: 7px 8px;
            border-radius: 6px;
            background: radial-gradient(circle at top, rgba(43, 27, 10, 1), #050307);
            border: 1px solid rgba(248, 214, 109, 0.52);
            box-shadow:
                0 0 14px rgba(0, 0, 0, 1),
                0 0 24px rgba(0, 0, 0, 1);
            color: var(--wow-text-main);
            pointer-events: none;
            max-width: 260px;
            font-size: 10px;
        }

        .wow-tooltip .quality-common { color: var(--wow-rarity-common); }
        .wow-tooltip .quality-uncommon { color: var(--wow-rarity-uncommon); }
        .wow-tooltip .quality-rare { color: var(--wow-rarity-rare); }
        .wow-tooltip .quality-epic { color: var(--wow-rarity-epic); }
        .wow-tooltip .quality-legendary { color: var(--wow-rarity-legendary); }

        .wow-tabs {
            display: inline-flex;
            gap: 4px;
            padding: 2px;
            border-radius: 999px;
            background: rgba(5, 3, 1, 0.98);
            border: 1px solid rgba(248, 214, 109, 0.22);
            box-shadow: 0 0 8px rgba(0, 0, 0, 1);
        }

        .wow-tab {
            padding: 2px 8px 3px 8px;
            font-size: 9px;
            text-transform: uppercase;
            letter-spacing: 0.11em;
            border-radius: 999px;
            color: var(--wow-text-soft);
            cursor: default;
        }

        .wow-tab-active {
            background: radial-gradient(circle at 20% 0%, rgba(248, 214, 109, 0.24), rgba(24, 10, 4, 1));
            color: var(--wow-accent-gold);
            box-shadow:
                0 0 10px rgba(0, 0, 0, 1),
                0 0 14px rgba(248, 214, 109, 0.25);
        }

        .achievement-glow {
            box-shadow:
                0 0 18px rgba(248, 214, 109, 0.55),
                0 0 32px rgba(0, 0, 0, 1);
            border-color: var(--wow-border-highlight) !important;
        }

        .achievement-title-lit {
            color: #ffe9a3 !important;
            text-shadow:
                0 0 8px rgba(0, 0, 0, 1),
                0 0 18px rgba(248, 214, 109, 0.9),
                0 0 26px rgba(255, 255, 255, 0.22);
        }

        .achievement-grid {
            display: grid;
            grid-template-columns: repeat(2, minmax(0, 1fr));
            gap: 6px;
            margin-top: 6px;
        }

        .achievement-card {
            position: relative;
            padding: 5px 6px 16px 6px;
            border-radius: 8px;
            border: 1px solid rgba(110, 88, 52, 0.7);
            background: radial-gradient(circle at 20% 0%, rgba(248, 214, 109, 0.05), rgba(6, 4, 2, 1));
            box-shadow: inset 0 0 6px rgba(0, 0, 0, 1);
            display: flex;
            flex-direction: column;
            gap: 3px;
            font-size: 8px;
            color: var(--wow-text-soft);
            opacity: 0.5;
            filter: grayscale(1);
            transition: all 0.18s ease-out;
        }

        .achievement-card-title {
            font-size: 10px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.09em;
            color: var(--wow-text-muted);
        }

        .achievement-card-desc {
            font-size: 9px;
            color: var(--wow-text-soft);
        }

        .achievement-card-icon {
            position: absolute;
            bottom: 4px;
            right: 5px;
            width: 18px;
            height: 18px;
            opacity: 0.8;
        }

        .achievement-card-icon img {
            width: 100%;
            height: 100%;
            object-fit: contain;
            display: block;
        }

        .achievement-card-earned {
            opacity: 1;
            filter: none;
            border-color: rgba(248, 214, 109, 0.85);
            box-shadow:
                0 0 10px rgba(248, 214, 109, 0.45),
                0 0 16px rgba(0, 0, 0, 1);
        }

        .achievement-card-earned .achievement-card-title {
            color: #ffe9a3;
            text-shadow:
                0 0 6px rgba(0, 0, 0, 1),
                0 0 10px rgba(248, 214, 109, 0.5);
        }

        .achievement-card-earned .achievement-card-desc {
            color: #fffbde;
        }

        .success-msg {
            opacity: 0;
            transition: opacity 1s ease-in-out;
        }

        .success-msg.show {
            opacity: 1;
        }

        input::-webkit-outer-spin-button,
        input::-webkit-inner-spin-button {
          -webkit-appearance: none;
          margin: 0;
        }

        input[type=number] {
          -moz-appearance: textfield;
        }

        .quality-common { color: var(--wow-rarity-common); }
        .quality-uncommon { color: var(--wow-rarity-uncommon); }
        .quality-rare { color: var(--wow-rarity-rare); }
        .quality-epic { color: var(--wow-rarity-epic); }
        .quality-legendary { color: var(--wow-rarity-legendary); }

        select#filterQuality.quality-common { color: var(--wow-rarity-common); }
        select#filterQuality.quality-uncommon { color: var(--wow-rarity-uncommon); }
        select#filterQuality.quality-rare { color: var(--wow-rarity-rare); }
        select#filterQuality.quality-epic { color: var(--wow-rarity-epic); }
        select#filterQuality.quality-legendary { color: var(--wow-rarity-legendary); }

        .coin {
            width: 1.25em;
            height: 1.25em;
            vertical-align: middle;
            margin-left: 2px;
            flex-shrink: 0;
        }

        #itemList::-webkit-scrollbar {
            width: 8px;
        }

        #itemList::-webkit-scrollbar-track {
            background: rgba(10,5,2,0.8);
            border-radius: 10px;
        }

        #itemList::-webkit-scrollbar-thumb {
            background: #4d2c1a;
            border-radius: 10px;
        }

        #itemList::-webkit-scrollbar-thumb:hover {
            background: #ffa500;
        }

        .icon-container.active-slot {
            outline: 2px solid #ffD100;
            box-shadow: 0 0 8px rgba(255, 209, 0, 0.7);
        }

        .clear-slot-btn {
            position: absolute;
            top: -0.5rem;
            right: -0.5rem;
            width: 1.25rem;
            height: 1.25rem;
            border-radius: 9999px;
            background-color: #500;
            color: #ffd100;
            border: 1px solid #989898;
            font-size: 0.75rem;
            line-height: 1;
            text-align: center;
            opacity: 0;
            transition: opacity 0.2s;
            cursor: pointer;
            z-index: 10;
        }

        .item-slot-container:hover .clear-slot-btn {
            opacity: 1;
        }

        @media (min-width: 1280px) {
            .wow-main {
                grid-template-columns: 3fr 1fr;
                gap: 18px;
            }
            .wow-header-title {
                font-size: 32px;
            }
        }

        @media (min-width: 1024px) and (max-width: 1279px) {
            .wow-frame {
                max-width: 1100px;
                padding: 14px;
            }
            .wow-main {
                grid-template-columns: 2.4fr 1fr;
                gap: 12px;
            }
            .wow-header-title {
                font-size: 26px;
            }
            .wow-header-subtitle {
                font-size: 12px;
            }
        }

        @media (max-width: 1024px) {
            .wow-main {
                grid-template-columns: 1fr;
            }
            .wow-main-right {
                margin-top: 4px;
            }
            .wow-frame {
                margin: 10px auto 16px auto;
                padding: 10px;
            }
            .hero-summary {
                grid-template-columns: auto 1fr;
            }
        }

        @media (max-width: 640px) {
            .hero-name {
                font-size: 14px;
            }
            .wow-header-title {
                font-size: 22px;
                letter-spacing: 0.14em;
            }
            .wow-panel {
                padding: 8px;
            }
        }
    </style>
</head>
<body class="wow-page antialiased tracking-wide">
    <div class="wow-frame">
        <header class="wow-header">
            <h1 class="wow-header-title">Murloc RPG 2 Save Scrivener</h1>
            <p class="wow-header-subtitle">Present your save scroll or inscribe its contents below.</p>
            <div class="wow-header-divider"></div>
        </header>

        <div class="wow-main">

            <!-- Left Column: Main Editor -->
            <div class="wow-main-left">
                <div class="wow-panel">
                    <div class="wow-panel-title">Save Scroll</div>
                    <div class="space-y-3">
                        <div>
                            <label for="fileInput" class="wow-label">1. Present Save Scroll (.sav)</label>
                            <input type="file" id="fileInput" accept=".sav" class="wow-input">
                        </div>
                        <div>
                            <label for="inputJson" class="wow-label">2. Or Inscribe Save Data</label>
                            <textarea id="inputJson" placeholder="The chronicle of your journey will appear here..." class="wow-textarea h-40"></textarea>
                        </div>
                    </div>
                </div>

                <div id="statEditor" class="hidden space-y-3">
                    <!-- Hero Summary -->
                    <div class="wow-panel hero-summary">
                        <div class="hero-portrait"></div>
                        <div class="hero-text-block">
                            <div class="hero-name" id="heroName">The Legendary Hero : Murloc</div>

                            <!-- Hero Banner Row 1: Class (read-only, mirrors ledger) -->
                            <div class="hero-banner-row hero-banner-row-1">
                                <div class="hero-pill hero-class-pill">
                                    <span class="hero-pill-label">Class</span>
                                    <span class="hero-pill-value hero-class" id="heroClassValue">N/A</span>
                                </div>
                            </div>

                            <!-- Hero Banner Row 2: Level + XP -->
                            <div class="hero-banner-row hero-banner-row-2">
                                <div class="hero-pill hero-level-pill">
                                    <span class="hero-pill-label">Lv.</span>
                                    <input
                                        type="number"
                                        id="playerLevel"
                                        min="1"
                                        max="40"
                                        class="hero-level-input hero-pill-value"
                                    >
                                </div>
                                <div class="hero-pill hero-xp-pill">
                                    <span class="hero-pill-label">XP</span>
                                    <input
                                        type="number"
                                        id="playerXP"
                                        min="0"
                                        max="22400"
                                        class="hero-xp-input hero-pill-value"
                                    >
                                </div>
                            </div>

                            <!-- Hero Banner Row 3: Current Zone (display-only, mirrors currentZone) -->
                            <div class="hero-banner-row hero-banner-row-3">
                                <div class="hero-pill hero-location-pill">
                                    <span class="hero-pill-label">Current Zone</span>
                                    <span class="hero-pill-value" id="heroZoneValue">N/A</span>
                                </div>
                                <div class="hero-pill hero-gold-pill">
                                    <span class="hero-pill-label">Gold</span>
                                    <div class="hero-pill-value hero-gold-field">
                                        <input
                                            type="number"
                                            id="playerMoneyGold"
                                            min="0"
                                            class="hero-gold-input"
                                        >
                                        <img src="https://wow.zamimg.com/images/icons/money-gold.gif" class="coin" alt="Gold">
                                    </div>
                                    <div class="hero-pill-value hero-gold-field">
                                        <input
                                            type="number"
                                            id="playerMoneySilver"
                                            min="0"
                                            max="99"
                                            class="hero-silver-input"
                                        >
                                        <img src="https://wow.zamimg.com/images/icons/money-silver.gif" class="coin" alt="Silver">
                                    </div>
                                    <div class="hero-pill-value hero-gold-field">
                                        <input
                                            type="number"
                                            id="playerMoneyCopper"
                                            min="0"
                                            max="99"
                                            class="hero-copper-input"
                                        >
                                        <img src="https://wow.zamimg.com/images/icons/money-copper.gif" class="coin" alt="Copper">
                                    </div>
                                </div>
                            </div>

                            <!-- Hidden technical field to preserve JS behavior -->
                            <input
                                type="text"
                                id="currentZone"
                                value="N/A"
                            >

                            <!-- Gold summary now shown via hero-gold-pill above -->
                        </div>
                    </div>

                    <!-- Achievement Panel -->
                    <div id="achievementPanel" class="wow-panel stats-panel">
                        <div id="achievementTitle" class="wow-panel-title">Achievement</div>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                            <div class="wow-subpanel">
                                <label for="playTime" class="wow-label">Play Time (seconds)</label>
                                <input type="number" id="playTime" min="0" class="wow-input" placeholder="Enter play time in seconds">
                            </div>
                            <div class="wow-subpanel">
                                <label for="unlockedChests" class="wow-label">Unlocked Chests</label>
                                <input type="number" id="unlockedChests" min="0" class="wow-input" placeholder="Enter chest value">
                            </div>
                        </div>
                        <div id="achievementBadges" class="achievement-grid"></div>
                    </div>

                    <!-- Hidden authoritative class field preserved for JS -->
                    <input type="text" id="playerClass" readonly class="wow-input cursor-not-allowed hidden">

                    <!-- Abilities & Quests Panel -->
                    <div id="abilitiesQuestsSection" class="wow-panel quests-panel">
                        <div class="wow-panel-title">Abilities & Quests</div>
                        <div class="space-y-3">
                            <div class="wow-subpanel">
                                <label for="playerAbilities" class="wow-label">Player Abilities (one per line)</label>
                                <textarea id="playerAbilities" placeholder="ab_fireball&#x0a;ab_frostbolt" class="wow-textarea h-24"></textarea>
                            </div>
                            <div class="wow-subpanel">
                                <label for="activeQuests" class="wow-label">Active Quests (one per line)</label>
                                <textarea id="activeQuests" placeholder="quest_crystal_pylons" class="wow-textarea h-24"></textarea>
                            </div>
                            <div class="wow-subpanel">
                                <label for="completedQuests" class="wow-label">Completed Quests (one per line)</label>
                                <textarea id="completedQuests" placeholder="quest_001&#x0a;quest_gizbo_armor&#x0a;quest_best_defense2" class="wow-textarea h-24"></textarea>
                            </div>
                        </div>
                    </div>

                    <!-- Equipment Panel -->
                    <div id="equipmentSection" class="wow-panel equipment-panel">
                        <div class="wow-panel-title">Equipment</div>
                        <div class="wow-subpanel mb-2">
                            <div class="text-xs text-amber-300">
                                <strong>Warning:</strong> Modifying equipment with invalid items or slots may cause issues in-game. Proceed with caution.
                            </div>
                        </div>
                        <div id="equipmentSlots" class="equipment-grid">
                            <!-- Equipment slots populated by JS -->
                        </div>
                    </div>

                    <!-- Inventory / Bags Panel -->
                    <div id="bagsSection" class="wow-panel inventory-panel">
                        <div class="wow-panel-title">Bags & Inventory</div>

                        <div id="bag1-container" class="wow-subpanel bag-panel">
                            <label class="wow-label">Bag 1: Backpack (16 Slots)</label>
                            <div id="bag1-slots" class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-4 gap-2"></div>
                        </div>

                        <div id="bag2-container" class="wow-subpanel bag-panel">
                            <div class="flex items-center mb-2 gap-2">
                                <label class="wow-label mb-0">Bag 2</label>
                                <div id="bag2-type-slot" class="item-slot-container wow-slot">
                                    <div class="icon-container slot-icon"></div>
                                    <div class="info-container flex flex-col justify-center overflow-hidden">
                                        <div class="item-name-display slot-name"></div>
                                        <input type="text" class="item-id-input slot-input" placeholder="item_id...">
                                    </div>
                                    <button class="clear-slot-btn" title="Clear Slot">x</button>
                                </div>
                            </div>
                            <div id="bag2-slots" class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-4 gap-2"></div>
                        </div>

                        <div id="bag3-container" class="wow-subpanel bag-panel">
                            <div class="flex items-center mb-2 gap-2">
                                <label class="wow-label mb-0">Bag 3</label>
                                <div id="bag3-type-slot" class="item-slot-container wow-slot">
                                    <div class="icon-container slot-icon"></div>
                                    <div class="info-container flex flex-col justify-center overflow-hidden">
                                        <div class="item-name-display slot-name"></div>
                                        <input type="text" class="item-id-input slot-input" placeholder="item_id...">
                                    </div>
                                    <button class="clear-slot-btn" title="Clear Slot">x</button>
                                </div>
                            </div>
                            <div id="bag3-slots" class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-4 gap-2"></div>
                        </div>
                    </div>
                </div>

                <button id="calculateButton" class="wow-button wow-button-primary w-full mt-3 text-2xl">Re-forge Seal</button>

                <p id="error" class="text-red-400 font-bold text-center text-sm mt-2"></p>

                <div class="wow-panel mt-2">
                    <div class="wow-panel-title">Resealed Scroll</div>
                    <textarea id="outputJson" readonly placeholder="Your newly forged chronicle will be revealed here..." class="wow-textarea h-40"></textarea>
                </div>
                
                <div id="exportSection" class="hidden mt-2">
                    <div class="wow-panel">
                        <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-3">
                            <div>
                                <label for="saveFileName" class="wow-label">Export File Name</label>
                                <div class="flex items-center gap-1">
                                    <input type="text" id="saveFileName" value="murloc_save" class="wow-input w-40">
                                    <span class="text-stone-400 font-mono text-xs">.sav</span>
                                </div>
                            </div>
                            <button id="exportButton" class="wow-button wow-button-secondary md:px-5 md:py-2">Capture Scroll</button>
                        </div>
                        <p id="successMsg" class="success-msg text-green-400 text-center font-bold text-xs mt-2">Scroll successfully captured!</p>
                    </div>
                </div>
            </div>

            <!-- Right Column: Item Codex -->
            <div class="wow-main-right">
                <div class="wow-panel codex-panel">
                    <div class="wow-panel-title">Item Codex</div>

                    <div id="codexFilters" class="grid grid-cols-2 gap-2 mb-2">
                        <select id="filterQuality" class="filter-select wow-select text-xs">
                            <option value="all">All Qualities</option>
                        </select>
                        <select id="filterType" class="filter-select wow-select text-xs">
                            <option value="all">All Types</option>
                        </select>
                        <select id="filterLoc" class="filter-select wow-select text-xs">
                            <option value="all">All Slots</option>
                        </select>
                        <select id="filterMat" class="filter-select wow-select text-xs">
                            <option value="all">All Materials</option>
                        </select>
                    </div>

                    <div class="relative mb-2">
                        <input type="text" id="itemSearch" placeholder="Search for items..." class="wow-input">
                    </div>

                    <div id="itemList" class="codex-list space-y-1">
                        <!-- Item list populated by JS -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="tooltip" class="hidden wow-tooltip"></div>
    <script src="database/item.js"></script>
    <script src="database/effect.js"></script>
    <script>
        // --- DATABASE & DATA TABLES ---

        const emptySlotIcons = {
            'Head': 'https://wow.zamimg.com/images/wow/icons/large/inventoryslot_head.jpg',
            'Neck': 'https://wow.zamimg.com/images/wow/icons/large/inventoryslot_neck.jpg',
            'Shoulders': 'https://wow.zamimg.com/images/wow/icons/large/inventoryslot_shoulder.jpg',
            'Back': 'https://wow.zamimg.com/images/wow/icons/large/inventoryslot_chest.jpg',
            'Chest': 'https://wow.zamimg.com/images/wow/icons/large/inventoryslot_chest.jpg',
            'Wrist': 'https://wow.zamimg.com/images/wow/icons/large/inventoryslot_wrists.jpg',
            'Weapon': 'https://wow.zamimg.com/images/wow/icons/large/inventoryslot_mainhand.jpg',
            'Gloves': 'https://wow.zamimg.com/images/wow/icons/large/inventoryslot_hands.jpg',
            'Belt': 'https://wow.zamimg.com/images/wow/icons/large/inventoryslot_waist.jpg',
            'Legs': 'https://wow.zamimg.com/images/wow/icons/large/inventoryslot_legs.jpg',
            'Boots': 'https://wow.zamimg.com/images/wow/icons/large/inventoryslot_feet.jpg',
            'Ring': 'https://wow.zamimg.com/images/wow/icons/large/inventoryslot_finger.jpg',
            'Trinket': 'https://wow.zamimg.com/images/wow/icons/large/inventoryslot_trinket.jpg',
            'Bag': 'https://wow.zamimg.com/images/wow/icons/large/inventoryslot_bag.jpg',
            'Inventory': 'https://wow.zamimg.com/images/wow/icons/large/inventoryslot_empty.jpg'
        };

        const equipmentSlotMap = [
            'Weapon', 'Head', 'Neck', 'Shoulders', 'Back', 'Chest', 
            'Wrist', 'Gloves', 'Belt', 'Legs', 'Boots', 'Ring', 'Trinket'
        ];

        let itemDB = {};
        try {
            if (itemDBJSON && itemDBJSON.trim() !== '') {
                itemDB = JSON.parse(itemDBJSON);
            }
        } catch (e) {
            if(itemDBJSON.trim() !== ''){
                alert("The embedded item database is corrupted. Please check for syntax errors.");
                console.error("Error parsing embedded JSON:", e);
            }
        }
        
        let effectDB = {};
        try {
            if (effectDBJSON && effectDBJSON.trim() !== '') {
                effectDB = JSON.parse(effectDBJSON);
            }
        } catch (e) {
            if(effectDBJSON.trim() !== ''){
                alert("The embedded effect database is corrupted. Please check for syntax errors.");
                console.error("Error parsing embedded effect JSON:", e);
            }
        }

        const xpToLvl = { 1: 0, 2: 100, 3: 300, 4: 600, 5: 900, 6: 1200, 7: 1600, 8: 2000, 9: 2400, 10: 2800, 11: 3200, 12: 3700, 13: 4200, 14: 4700, 15: 5200, 16: 5700, 17: 6200, 18: 6800, 19: 7400, 20: 8000, 21: 8600, 22: 9200, 23: 9800, 24: 10400, 25: 11100, 26: 11800, 27: 12500, 28: 13200, 29: 13900, 30: 14600, 31: 15300, 32: 16000, 33: 16800, 34: 17600, 35: 18400, 36: 19200, 37: 20000, 38: 20800, 39: 21600, 40: 22400 };
        
        const attributeMap = { str: 'Strength', agi: 'Agility', sta: 'Stamina', int: 'Intellect' };

        const filterValueSets = {
            qualities: ['common', 'uncommon', 'rare', 'epic', 'legendary'],
            types: new Set(),
            locs: new Set(),
            mats: new Set()
        };

        let activeSlotDisplay = null;

        // --- CORE HELPER FUNCTIONS ---
        function getEffect(effectId) {
            if (!effectId) return null;
            return effectDB[effectId.toLowerCase()] || null;
        }

        function getItem(itemId) {
            if (!itemId) return null;
            return itemDB[itemId.toLowerCase()] || null;
        }

        function getItemStackSize(itemId) {
            const item = getItem(itemId);
            return item ? item.stack || 1 : 1;
        }

        function getBagSlotCount(itemId) {
            if (!itemId) return 0;
            if (itemId === 'backpack') return 16;
            const item = getItem(itemId);
            return item && item.type === 'bag' ? item.slots : 0;
        }
        
        function formatCurrency(copperValue) {
            if (isNaN(copperValue) || copperValue <= 0) return '';
            const gold = Math.floor(copperValue / 10000);
            const silver = Math.floor((copperValue % 10000) / 100);
            const copper = copperValue % 100;
            
            let parts = [];
            if (gold > 0) parts.push(`<span>${gold} <img src="https://wow.zamimg.com/images/icons/money-gold.gif" class="coin inline-block"></span>`);
            if (silver > 0) parts.push(`<span>${silver} <img src="https://wow.zamimg.com/images/icons/money-silver.gif" class="coin inline-block"></span>`);
            if (copper > 0) parts.push(`<span>${copper} <img src="https://wow.zamimg.com/images/icons/money-copper.gif" class="coin inline-block"></span>`);

            if (parts.length === 0) return '';
            return `<div class="text-stone-300">Sell Price: ${parts.join(' ')}</div>`;
        }

        function getXpForLevel(level) {
            return xpToLvl[Math.min(40, Math.max(1, level))] || 0;
        }

        function getLevelForXp(xp) {
            const levels = Object.keys(xpToLvl).map(Number).sort((a, b) => a - b);
            for (let i = levels.length - 1; i >= 0; i--) {
                if (xp >= xpToLvl[levels[i]]) return levels[i];
            }
            return 1;
        }

        function toActionScriptString(value) {
            if (typeof value === 'boolean') return String(value).toLowerCase();
            if (Array.isArray(value)) return value.map(toActionScriptString).join(',');
            if (value === null) return "";
            return String(value);
        }

        function calculateHash(data) {
            const fieldsInOrder = [ '_version', 'playTime', 'playerClass', 'playerMoney', 'playerXP', 'playerDir', 'playerCurrentHealth', 'playerCurrentPower', 'currentZone', 'currentZoneFrame', 'currentXPos', 'playerAbilities', 'playerEquipment', 'playerEffects', 'playerCooldowns', 'activeQuests', 'activeQuestKills', 'completedQuests', 'bag1', 'bag2', 'bag3', 'actionbar1', 'actionbar2', 'actionbar3', 'currentActionbar', 'vol_master', 'vol_music', 'vol_sfx', 'vol_ambience', 'loop_music', 'mute_all', 'show_fps', 'disable_combattext', 'default_autoloot', 'fx_screenshake', 'fx_environment', 'fx_battle', 'unlocked_chests', 'keyBind' ];
            let hashString = "";
            for (const field of fieldsInOrder) {
                const value = data[field];
                hashString += (field === 'activeQuestKills') ? "[object Object]" : toActionScriptString(value);
            }
            hashString += "1i3am3a7haXer";
            return CryptoJS.MD5(hashString).toString();
        }

        // --- UI & DATA BINDING FUNCTIONS ---
        
        function getSlotTypeFromContainer(slotContainer) {
            if (!slotContainer) return 'Inventory';

            const isEquipment = !!slotContainer.closest('#equipmentSlots');
            if (isEquipment) {
                const label = slotContainer.previousElementSibling;
                if (label && label.tagName === 'LABEL') {
                    return label.textContent;
                }
            }

            if (slotContainer.id.includes('-type-slot')) {
                return 'Bag';
            }

            return 'Inventory';
        }

        function updateSlotDisplay(slotContainer, itemId, slotType) {
            const item = getItem(itemId);
            
            const iconContainer = slotContainer.querySelector('.icon-container');
            const nameDisplay = slotContainer.querySelector('.item-name-display');
            const idInput = slotContainer.querySelector('.item-id-input');
            const qtyInput = slotContainer.querySelector('.item-qty-input');

            const isEquipment = !qtyInput;
            const nameClasses = isEquipment 
                ? 'item-name-display text-base truncate' 
                : 'item-name-display text-sm truncate';

            if (item && iconContainer && nameDisplay && idInput) {
                const iconUrl = item.icon ? `https://wow.zamimg.com/images/wow/icons/large/${item.icon.toLowerCase()}.jpg` : '';
                iconContainer.innerHTML = iconUrl ? `<img src="${iconUrl}" class="w-full h-full rounded" alt="${item.name}">` : '';
                
                nameDisplay.textContent = item.name;
                nameDisplay.title = item.name;
                nameDisplay.className = `${nameClasses} ${'quality-' + item.quality}`;
                
                idInput.value = item.id;
                
                if (qtyInput) {
                    qtyInput.max = item.stack || 1;
                    if (parseInt(qtyInput.value) === 0 || isNaN(parseInt(qtyInput.value))) {
                        qtyInput.value = 1;
                    }
                }
            } else if (iconContainer && nameDisplay && idInput) { // Empty the slot
                const placeholderIconUrl = emptySlotIcons[slotType];
                if (placeholderIconUrl) {
                    iconContainer.innerHTML = `<img src="${placeholderIconUrl}" class="w-full h-full rounded opacity-60" alt="${slotType} slot">`;
                } else {
                    iconContainer.innerHTML = '';
                }
                
                nameDisplay.textContent = 'Empty';
                nameDisplay.title = 'Empty';
                nameDisplay.className = `${nameClasses} quality-common`;

                idInput.value = '';
                
                if (qtyInput) {
                    qtyInput.value = 0;
                    qtyInput.max = 1;
                }
            }
        }

        function populateEquipmentUI(equipmentData) {
            const slotsContainer = document.getElementById('equipmentSlots');
            slotsContainer.innerHTML = `
                <div id="equipment-col-left" class="flex flex-col gap-4"></div>
                <div id="equipment-col-middle" class="flex flex-col justify-end"></div>
                <div id="equipment-col-right" class="flex flex-col gap-4"></div>
            `;

            const colLeft = document.getElementById('equipment-col-left');
            const colMiddle = document.getElementById('equipment-col-middle');
            const colRight = document.getElementById('equipment-col-right');

            const createSlotElement = (slotName, itemId, slotIndex) => {
                const slotWrapper = document.createElement('div');
                slotWrapper.dataset.slotIndex = slotIndex;
                slotWrapper.className = "bg-[rgba(30,20,10,0.7)] border border-[#4d2c1a] rounded-md p-3";
                
                slotWrapper.innerHTML = `
                    <label class="text-amber-200 font-semibold block mb-2">${slotName}</label>
                    <div class="item-slot-container relative grid grid-cols-[auto_1fr] items-center gap-x-3">
                        <div class="icon-container w-12 h-12 bg-black/30 border-2 border-stone-600 rounded flex items-center justify-center cursor-pointer"></div>
                        <div class="info-container flex flex-col justify-center overflow-hidden">
                            <div class="item-name-display"></div>
                            <input type="text" class="item-id-input text-sm font-mono text-stone-400 bg-transparent border-none p-0 h-5 focus:ring-1 focus:ring-amber-500 focus:bg-stone-800 rounded" placeholder="item_id...">
                        </div>
                        <button class="clear-slot-btn" title="Clear Slot">x</button>
                    </div>
                `;
                
                updateSlotDisplay(slotWrapper.querySelector('.item-slot-container'), itemId, slotName);
                return slotWrapper;
            };

            const slotDefinitions = [
                { name: 'Head',      index: 1,  column: colLeft },
                { name: 'Neck',      index: 2,  column: colLeft },
                { name: 'Shoulders', index: 3,  column: colLeft },
                { name: 'Back',      index: 4,  column: colLeft },
                { name: 'Chest',     index: 5,  column: colLeft },
                { name: 'Wrist',     index: 6,  column: colLeft },
                { name: 'Weapon',    index: 0,  column: colMiddle },
                { name: 'Gloves',    index: 7,  column: colRight },
                { name: 'Belt',      index: 8,  column: colRight },
                { name: 'Legs',      index: 9,  column: colRight },
                { name: 'Boots',     index: 10, column: colRight },
                { name: 'Ring',      index: 11, column: colRight },
                { name: 'Trinket',   index: 12, column: colRight }
            ];

            slotDefinitions.forEach(def => {
                const itemId = (equipmentData && equipmentData[def.index]) ? equipmentData[def.index] : '';
                const slotElement = createSlotElement(def.name, itemId, def.index);
                def.column.appendChild(slotElement);
            });
        }
        
        function readEquipmentFromUI() {
            const equipmentData = new Array(equipmentSlotMap.length).fill(null);
            const slotWrappers = document.querySelectorAll('#equipmentSlots [data-slot-index]');

            slotWrappers.forEach(wrapper => {
                const index = parseInt(wrapper.dataset.slotIndex, 10);
                const input = wrapper.querySelector('.item-id-input');
                if (input && !isNaN(index) && index < equipmentData.length) {
                    equipmentData[index] = input.value.trim() || null;
                }
            });
            return equipmentData;
        }

        function createSlotHTML(slotIndex, itemData) {
            const itemId = itemData && itemData[0] ? itemData[0] : '';
            const quantity = itemData && itemData[1] !== undefined ? itemData[1] : 0;
            const item = getItem(itemId);

            const iconUrl = item && item.icon ? `https://wow.zamimg.com/images/wow/icons/large/${item.icon.toLowerCase()}.jpg` : '';
            const itemName = item ? item.name : 'Empty';
            const itemQuality = item ? item.quality : 'common';
            const maxStack = getItemStackSize(itemId);

            let iconContent = '';
            if (iconUrl) {
                iconContent = `<img src="${iconUrl}" class="w-full h-full rounded" alt="${itemName}">`;
            } else {
                iconContent = `<img src="${emptySlotIcons['Inventory']}" class="w-full h-full rounded opacity-60" alt="Empty inventory slot">`;
            }

            return `
                <div class="item-slot-container relative grid grid-cols-[auto_1fr_auto] items-center gap-x-2 p-1.5 border border-stone-700 rounded bg-black/20">
                    <div class="icon-container w-10 h-10 bg-black/30 border-2 border-stone-600 rounded flex items-center justify-center cursor-pointer">
                        ${iconContent}
                    </div>
                    <div class="info-container flex flex-col justify-center overflow-hidden">
                        <div class="item-name-display text-sm truncate ${'quality-' + itemQuality}" title="${itemName}">${itemName}</div>
                        <input type="text" class="item-id-input text-xs font-mono text-stone-400 bg-transparent border-none p-0 h-5 focus:ring-1 focus:ring-amber-500 focus:bg-stone-800 rounded" value="${itemId}" placeholder="item_id...">
                    </div>
                    <div class="quantity-container">
                        <input type="number" class="item-qty-input bg-[rgba(10,5,2,0.8)] border border-[#4d2c1a] text-stone-200 rounded p-1.5 focus:outline-none focus:border-[#ffa500] font-mono text-xs text-right w-8" value="${quantity}" min="0" max="${maxStack}">
                    </div>
                    <button class="clear-slot-btn" title="Clear Slot">x</button>
                </div>
            `;
        }

        function populateBagUI(bagKey, bagData) {
            const bagContainer = document.getElementById(`${bagKey}-container`);
            if (!bagContainer) return;

            const slotsContainer = bagContainer.querySelector(`#${bagKey}-slots`);
            const bagTypeSlot = bagContainer.querySelector(`#${bagKey}-type-slot`);
            
            const bagId = (Array.isArray(bagData) && bagData.length > 0) ? bagData[0] : '';
            
            if (bagTypeSlot) { // For bag2 and bag3 which have a dedicated slot for the bag item
                updateSlotDisplay(bagTypeSlot, bagId, 'Bag');
            }

            if (!slotsContainer) return;
            slotsContainer.innerHTML = '';

            const slotCount = getBagSlotCount(bagId);
            for (let i = 1; i <= slotCount; i++) {
                const slotData = bagData ? bagData[i] : null;
                const displayData = Array.isArray(slotData) && slotData[0] === "empty" && slotData[1] === 0 ? null : slotData;
                slotsContainer.innerHTML += createSlotHTML(i, displayData);
            }
        }
        
        function readBagFromUI(bagKey) {
            const bagContainer = document.getElementById(`${bagKey}-container`);
            if (!bagContainer) return [];

            let bagId;
            if (bagKey === 'bag1') {
                bagId = 'backpack';
            } else {
                const bagTypeInput = bagContainer.querySelector(`#${bagKey}-type-slot .item-id-input`);
                bagId = bagTypeInput ? bagTypeInput.value.trim() : '';
            }

            if (!bagId) return [];

            const finalBagData = [bagId];
            const slotContainers = bagContainer.querySelectorAll(`#${bagKey}-slots .item-slot-container`);
            slotContainers.forEach(slot => {
                const idInput = slot.querySelector('.item-id-input');
                const qtyInput = slot.querySelector('.item-qty-input');
                const itemId = idInput ? idInput.value.trim() : '';
                const quantity = qtyInput ? parseInt(qtyInput.value, 10) : 0;
                
                if (!itemId) {
                    finalBagData.push(["empty", 0]);
                } else {
                    finalBagData.push([itemId, isNaN(quantity) ? 0 : quantity]);
                }
            });
            return finalBagData;
        }

        // --- TOOLTIP FUNCTIONS ---
        function showTooltip(itemId, event) {
            const item = getItem(itemId);
            const tooltip = document.getElementById('tooltip');
            if (!item) {
                tooltip.classList.add('hidden');
                return;
            }

            // --- Part 1: Icon ---
            let iconHtml = '';
            if (item.icon) {
                const iconUrl = `https://wow.zamimg.com/images/wow/icons/large/${item.icon.toLowerCase()}.jpg`;
                iconHtml = `
                    <div class="flex-shrink-0">
                        <img src="${iconUrl}" class="w-14 h-14 border-2 border-stone-500 rounded" alt="${item.name}">
                    </div>
                `;
            }

            // --- Part 2: Text Content Blocks ---
            const textBlocks = [];

            // Block: Name
            textBlocks.push(`<div class="font-bold text-lg ${'quality-' + item.quality}">${item.name}</div>`);

            // Block: Sub-header (Slot, Type)
            const locText = item.loc && item.loc !== 'none' ? item.loc.charAt(0).toUpperCase() + item.loc.slice(1) : null;
            const matText = item.mat && item.mat !== 'none' ? item.mat.charAt(0).toUpperCase() + item.mat.slice(1) : null;
            let subHeaderHtml = '';
            if (item.type === 'bag' && item.slots > 0) {
                subHeaderHtml = `<div>${item.slots} Slot Bag</div>`;
            } else if (locText && matText) {
                subHeaderHtml = `<div class="flex justify-between text-stone-300"><span>${locText}</span><span>${matText}</span></div>`;
            } else if (locText) {
                subHeaderHtml = `<div class="text-stone-300">${locText}</div>`;
            } else if (matText) {
                subHeaderHtml = `<div class="text-stone-300">${matText}</div>`;
            } else if (item.type) {
                subHeaderHtml = `<div class="text-stone-300">${item.type.charAt(0).toUpperCase() + item.type.slice(1)}</div>`;
            }
            if (subHeaderHtml) textBlocks.push(subHeaderHtml);

            // Block: Main Info (Armor, Damage)
            let mainInfoHtml = '';
            if (item.armor > 0) mainInfoHtml += `<div>${item.armor} Armor</div>`;
            if (item.dmgmin > 0) mainInfoHtml += `<div>${item.dmgmin} - ${item.dmgmax} Damage</div>`;
            if (mainInfoHtml) textBlocks.push(mainInfoHtml);

            // Block: Stats
            if (item.stats && item.stats.length > 0) {
                const statsHtml = item.stats.map(s => {
                    const statName = attributeMap[s.stat] || s.stat.charAt(0).toUpperCase() + s.stat.slice(1);
                    return `<div class="text-green-400">+${s.num} ${statName}</div>`;
                }).join('');
                textBlocks.push(`<div>${statsHtml}</div>`);
            }

            // Block: Effects - Collect all explicit and derived effects
            const effectsToShow = [];
            if (item.effects && item.effects.length > 0) {
                effectsToShow.push(...item.effects);
            }
            // For consumables, derive the effect from the ability ID
            if (item.type === 'consumable' && item.abil) {
                const derivedEffectId = item.abil.replace('abil_', 'eff_');
                if (getEffect(derivedEffectId) && !effectsToShow.some(e => e.value === derivedEffectId)) {
                     effectsToShow.push({ value: derivedEffectId });
                }
            }

            if (effectsToShow.length > 0) {
                const effectDescriptions = effectsToShow.map(effectRef => {
                    const effect = getEffect(effectRef.value);
                    if (!effect) return '';
                    
                    // A consumable is always "Use". Other items are "Equip" if passive (rounds: 0).
                    const prefix = (item.type === 'consumable' || effect.rounds !== 0) ? 'Use' : 'Equip';
                    const descriptions = [];
                    let durationHandled = false;

                    if (effect.stats && effect.stats.length > 0) {
                        effect.stats.forEach(s => {
                            const statName = attributeMap[s.stat] || s.stat.charAt(0).toUpperCase() + s.stat.slice(1);
                            const verb = s.num > 0 ? 'Increases' : 'Decreases';
                            descriptions.push(`${verb} ${statName} by ${Math.abs(s.num)}.`);
                        });
                    }
                    if (effect.pcrit > 0) descriptions.push(`Increases melee critical strike chance by ${effect.pcrit}%.`);
                    if (effect.spcrit > 0) descriptions.push(`Increases spell critical strike chance by ${effect.spcrit}%.`);
                    if (effect.phit > 0) descriptions.push(`Increases melee hit chance by ${effect.phit}%.`);
                    if (effect.sphit > 0) descriptions.push(`Increases spell hit chance by ${effect.sphit}%.`);
                    if (effect.pdodge > 0) descriptions.push(`Increases dodge chance by ${effect.pdodge}%.`);
                    if (effect.hpmod !== 0) {
                        if (effect.hpmod > 0) descriptions.push(`Restores ${effect.hpmod} health per round.`);
                        else descriptions.push(`Inflicts ${Math.abs(effect.hpmod)} damage per round.`);
                    }
                    if (effect.powermod !== 0) {
                        if (effect.powermod > 0) descriptions.push(`Restores ${effect.powermod} power per round.`);
                        else descriptions.push(`Drains ${Math.abs(effect.powermod)} power per round.`);
                    }

                    if (effect.stun) {
                        if (effect.rounds > 0) {
                           descriptions.push(`Stuns the target for ${effect.rounds} rounds.`);
                           durationHandled = true;
                        } else {
                           descriptions.push('Stuns the target.');
                        }
                    }
                    if (effect.silence) {
                        if (effect.rounds > 0) {
                           descriptions.push(`Silences the target for ${effect.rounds} rounds.`);
                           durationHandled = true;
                        } else {
                           descriptions.push('Silences the target.');
                        }
                    }
                    
                    if (descriptions.length === 0) return '';
                    let fullDescription = descriptions.join(' ');
                    if (effect.rounds > 0 && !durationHandled) {
                        fullDescription += ` Lasts for ${effect.rounds} rounds.`;
                    }
                    return `<div class="text-green-300">${prefix}: ${fullDescription}</div>`;
                }).filter(Boolean).join('');

                if (effectDescriptions) {
                    textBlocks.push(`<div class="space-y-1">${effectDescriptions}</div>`);
                }
            }

            // Block: Level Requirement
            if (item.level > 0) {
                if (item.type === 'trade' || item.type === 'quest') {
                    textBlocks.push(`<div class="text-yellow-400">Item Level ${item.level}</div>`);
                } else {
                    textBlocks.push(`<div class="text-stone-300">Requires Level ${item.level}</div>`);
                }
            }

            // Block: Description
            if (item.desc) textBlocks.push(`<div class="text-amber-300 italic">"${item.desc}"</div>`);
            
            // Block: Stack Size
            if (item.stack > 1) textBlocks.push(`<div class="text-stone-400">Max Stack: ${item.stack}</div>`);
            
            // Block: Sell Price
            if (item.val > 0) {
                textBlocks.push(formatCurrency(item.val));
            }
            
            // --- Part 3: Final Assembly ---
            const textPartHtml = textBlocks.join('');

            tooltip.innerHTML = `
                <div class="flex gap-3">
                    ${iconHtml}
                    <div class="flex-grow space-y-2">
                        ${textPartHtml}
                    </div>
                </div>
            `;

            tooltip.style.left = `${event.pageX + 15}px`;
            tooltip.style.top = `${event.pageY + 15}px`;
            tooltip.classList.remove('hidden');
        }

        function hideTooltip() {
            document.getElementById('tooltip').classList.add('hidden');
        }

        // --- ACHIEVEMENT RENDERING (shared) ---
        function renderAchievements(playTimeSeconds, unlockedChests) {
            const achievementPanel = document.getElementById('achievementPanel');
            const achievementTitle = document.getElementById('achievementTitle');
            const achievementBadges = document.getElementById('achievementBadges');
            if (!achievementPanel || !achievementTitle || !achievementBadges) return;

            const playTime = Math.max(0, parseInt(playTimeSeconds, 10) || 0);
            const unlocked = Math.max(0, parseInt(unlockedChests, 10) || 0);

            achievementPanel.classList.remove('achievement-glow');
            achievementTitle.classList.remove('achievement-title-lit');
            achievementBadges.innerHTML = '';

            const achievements = [
                // Playtime achievements
                {
                    id: 'pt5',
                    label: 'Stay a while and listem',
                    desc: 'Play for at least 5 minutes.',
                    earned: playTime >= 5 * 60,
                    icon: 'https://wow.zamimg.com/images/wow/icons/medium/spell_nature_timestop.jpg'
                },
                {
                    id: 'pt30',
                    label: 'Rookie Cookie',
                    desc: 'Play for at least 30 minutes.',
                    earned: playTime >= 30 * 60,
                    icon: 'https://wow.zamimg.com/images/wow/icons/medium/inv_misc_food_33.jpg'
                },
                {
                    id: 'pt60',
                    label: 'Timeless Tidewalker',
                    desc: 'Play for at least 1 hour.',
                    earned: playTime >= 60 * 60,
                    icon: 'https://wow.zamimg.com/images/wow/icons/medium/spell_holy_championsbond.jpg'
                },
                {
                    id: 'pt120',
                    label: '"Murloc"thon',
                    desc: 'Play for at least 2 hours.',
                    earned: playTime >= 120 * 60,
                    icon: 'https://wow.zamimg.com/images/wow/icons/medium/ability_racial_packhobgoblin.jpg'
                },
                {
                    id: 'pt180',
                    label: 'No Murloc No Life',
                    desc: 'Play for at least 3 hours.',
                    earned: playTime >= 180 * 60,
                    icon: 'https://wow.zamimg.com/images/wow/icons/medium/inv_pet_babyshark.jpg'
                },

                // Chest achievements
                {
                    id: 'chest1',
                    label: '"Trash"sure Hunter',
                    desc: 'Unlock at least 1 chest.',
                    earned: unlocked >= 1,
                    icon: 'https://wow.zamimg.com/images/wow/icons/medium/inv_box_01.jpg'
                },
                {
                    id: 'chest10',
                    label: 'Chest Appreciator',
                    desc: 'Unlock at least 10 chests.',
                    earned: unlocked >= 10,
                    icon: 'https://wow.zamimg.com/images/wow/icons/medium/inv_misc_treasurechest03a.jpg'
                },
                {
                    id: 'chest30',
                    label: 'Treasure Hunter',
                    desc: 'Unlock at least 30 chests.',
                    earned: unlocked >= 30,
                    icon: 'https://wow.zamimg.com/images/wow/icons/medium/achievement_general_stayclassy.jpg'
                },
                {
                    id: 'chest50',
                    label: 'Treasure Tsunami',
                    desc: 'Unlock at least 50 chests.',
                    earned: unlocked >= 50,
                    icon: 'https://wow.zamimg.com/images/wow/icons/medium/achievement_bg_overcome500disadvantage.jpg'
                },
                {
                    id: 'chest100',
                    label: 'Are you playing Fallout?',
                    desc: 'Unlock at least 100 chests.',
                    earned: unlocked >= 100,
                    icon: 'https://wow.zamimg.com/images/wow/icons/medium/inv_misc_gear_01.jpg'
                }
            ];

            let anyEarned = false;

            achievements.forEach(a => {
                const card = document.createElement('div');
                card.className = 'achievement-card' + (a.earned ? ' achievement-card-earned' : '');
                card.innerHTML = `
                    <div class="achievement-card-title">${a.label}</div>
                    <div class="achievement-card-desc">${a.desc}</div>
                    <div class="achievement-card-icon">
                        <img src="${a.icon}" alt="${a.label}">
                    </div>
                `;
                achievementBadges.appendChild(card);
                if (a.earned) {
                    anyEarned = true;
                }
            });

            if (anyEarned) {
                achievementPanel.classList.add('achievement-glow');
                achievementTitle.classList.add('achievement-title-lit');
            }
        }

        // --- SAVE DATA PROCESSING ---
        function loadSaveData(saveData) {
            document.getElementById('statEditor').classList.remove('hidden');
            
            const playerClass = saveData.playerClass || 'N/A';
            const currentZone = saveData.currentZone || 'N/A';

            // Keep authoritative hidden/technical fields in sync
            document.getElementById('playerClass').value = playerClass;
            document.getElementById('currentZone').value = currentZone;

            // Update hero banner display fields
            const heroClassValueEl = document.getElementById('heroClassValue');
            if (heroClassValueEl) {
                heroClassValueEl.textContent = playerClass;
            }

            const heroZoneValueEl = document.getElementById('heroZoneValue');
            if (heroZoneValueEl) {
                heroZoneValueEl.textContent = currentZone;
            }

            const totalCopper = Math.max(0, saveData.playerMoney || 0);
            document.getElementById('playerMoneyGold').value = Math.floor(totalCopper / 10000);
            document.getElementById('playerMoneySilver').value = Math.floor((totalCopper % 10000) / 100);
            document.getElementById('playerMoneyCopper').value = totalCopper % 100;
            
            const playTime = Math.max(0, saveData.playTime || 0);
            document.getElementById('playTime').value = playTime;

            const clampedXP = Math.min(22400, Math.max(0, saveData.playerXP || 0));
            document.getElementById('playerXP').value = clampedXP;
            document.getElementById('playerLevel').value = getLevelForXp(clampedXP);
            const unlocked = Math.max(0, saveData.unlocked_chests || 0);
            document.getElementById('unlockedChests').value = unlocked;

            // Render achievements based on loaded values (seed from current inputs)
            renderAchievements(
                document.getElementById('playTime').value,
                document.getElementById('unlockedChests').value
            );

            const playerAbilitiesEl = document.getElementById('playerAbilities');
            if (saveData.playerAbilities && Array.isArray(saveData.playerAbilities)) {
                playerAbilitiesEl.value = saveData.playerAbilities.join('\n');
            } else {
                playerAbilitiesEl.value = '';
            }

            const activeQuestsEl = document.getElementById('activeQuests');
            if (saveData.activeQuests && Array.isArray(saveData.activeQuests)) {
                activeQuestsEl.value = saveData.activeQuests.join('\n');
            } else {
                activeQuestsEl.value = '';
            }

            const completedQuestsEl = document.getElementById('completedQuests');
            if (saveData.completedQuests && Array.isArray(saveData.completedQuests)) {
                completedQuestsEl.value = saveData.completedQuests.join('\n');
            } else {
                completedQuestsEl.value = '';
            }

            populateEquipmentUI(saveData.playerEquipment || []);
            
            populateBagUI('bag1', saveData.bag1);
            populateBagUI('bag2', saveData.bag2);
            populateBagUI('bag3', saveData.bag3);
        }
        
        function applyEdits(saveData) {
            const gold = parseInt(document.getElementById('playerMoneyGold').value) || 0;
            const silver = parseInt(document.getElementById('playerMoneySilver').value) || 0;
            const copper = parseInt(document.getElementById('playerMoneyCopper').value) || 0;
            saveData.playerMoney = (gold * 10000) + (silver * 100) + copper;

            saveData.playTime = Number(document.getElementById('playTime').value);
            saveData.playerXP = getXpForLevel(parseInt(document.getElementById('playerLevel').value) || 1);
            saveData.unlocked_chests = Number(document.getElementById('unlockedChests').value);

            // Ensure achievements reflect the current input values after applying edits
            renderAchievements(saveData.playTime, saveData.unlocked_chests);

            // Keep achievements preview in sync when exporting
            renderAchievements(saveData.playTime, saveData.unlocked_chests);
            
            const playerAbilitiesStr = document.getElementById('playerAbilities').value.trim();
            if (playerAbilitiesStr) {
                saveData.playerAbilities = playerAbilitiesStr.split('\n').map(q => q.trim()).filter(q => q);
            } else {
                saveData.playerAbilities = [];
            }
            
            const activeQuestsStr = document.getElementById('activeQuests').value.trim();
            if (activeQuestsStr) {
                saveData.activeQuests = activeQuestsStr.split('\n').map(q => q.trim()).filter(q => q);
            } else {
                saveData.activeQuests = [];
            }

            const completedQuestsStr = document.getElementById('completedQuests').value.trim();
            if (completedQuestsStr) {
                saveData.completedQuests = completedQuestsStr.split('\n').map(q => q.trim()).filter(q => q);
            } else {
                saveData.completedQuests = [];
            }
            
            saveData.playerEquipment = readEquipmentFromUI();
            
            saveData.bag1 = readBagFromUI('bag1');
            saveData.bag2 = readBagFromUI('bag2');
            saveData.bag3 = readBagFromUI('bag3');
            return saveData;
        }

        // --- EVENT LISTENERS ---
        document.getElementById('playerLevel').addEventListener('input', function() {
            this.value = Math.min(40, Math.max(1, parseInt(this.value) || 1));
            document.getElementById('playerXP').value = getXpForLevel(this.value);
        });

        document.getElementById('playerXP').addEventListener('input', function() {
            this.value = Math.min(22400, Math.max(0, parseInt(this.value) || 0));
            document.getElementById('playerLevel').value = getLevelForXp(this.value);
        });

        // Live achievement updates when Achievement inputs change (single source of truth)
        (function () {
            const playTimeInput = document.getElementById('playTime');
            const unlockedChestsInput = document.getElementById('unlockedChests');

            if (!playTimeInput || !unlockedChestsInput) return;

            function syncAchievementsFromInputs() {
                const pt = Math.max(0, parseInt(playTimeInput.value, 10) || 0);
                const unlocked = Math.max(0, parseInt(unlockedChestsInput.value, 10) || 0);
                renderAchievements(pt, unlocked);
            }

            playTimeInput.addEventListener('input', function () {
                // clamp then update
                const pt = Math.max(0, parseInt(this.value, 10) || 0);
                if (String(pt) !== this.value) this.value = pt;
                syncAchievementsFromInputs();
            });

            unlockedChestsInput.addEventListener('input', function () {
                // clamp then update
                const unlocked = Math.max(0, parseInt(this.value, 10) || 0);
                if (String(unlocked) !== this.value) this.value = unlocked;
                syncAchievementsFromInputs();
            });

            // Initial render based on current input values
            syncAchievementsFromInputs();
        })();

        const editorContainer = document.getElementById('statEditor');

        function handleTooltip(event, show) {
            const target = event.target;
            const slotContainer = target.closest('.item-slot-container');
            if (slotContainer) {
                const idInput = slotContainer.querySelector('.item-id-input');
                if (idInput) {
                    const id = idInput.value;
                    if (show) {
                        showTooltip(id, event);
                    } else {
                        hideTooltip();
                    }
                }
            }
        }

        function deselectActiveSlot() {
            if (activeSlotDisplay) {
                activeSlotDisplay.classList.remove('active-slot');
                activeSlotDisplay = null;
            }
        }
        
        editorContainer.addEventListener('mouseover', e => handleTooltip(e, true));
        editorContainer.addEventListener('mouseout', e => handleTooltip(e, false));
        editorContainer.addEventListener('mousemove', e => {
            const tooltip = document.getElementById('tooltip');
            if (!tooltip.classList.contains('hidden')) {
                tooltip.style.left = `${e.pageX + 15}px`;
                tooltip.style.top = `${e.pageY + 15}px`;
            }
        });
        
        document.addEventListener('click', (e) => {
            const iconTarget = e.target.closest('.icon-container');
            const clearBtnTarget = e.target.closest('.clear-slot-btn');
            
            if (e.target.closest('#itemList a')) {
                return;
            }

            if (iconTarget) {
                if (activeSlotDisplay !== iconTarget) {
                    deselectActiveSlot();
                    activeSlotDisplay = iconTarget;
                    activeSlotDisplay.classList.add('active-slot');
                }
            } else if (clearBtnTarget) {
                const slotContainer = clearBtnTarget.closest('.item-slot-container');
                if (slotContainer) {
                    const slotType = getSlotTypeFromContainer(slotContainer);
                    updateSlotDisplay(slotContainer, null, slotType);

                    if (slotType === 'Bag' && slotContainer.id.includes('-type-slot')) {
                        const bagKey = slotContainer.id.slice(0, 4);
                        document.getElementById(`${bagKey}-slots`).innerHTML = '';
                    }
                }
            } else {
                deselectActiveSlot();
            }
        });

        editorContainer.addEventListener('blur', e => {
            if (e.target.matches('.item-id-input')) {
                const slotContainer = e.target.closest('.item-slot-container');
                if (slotContainer) {
                    const newId = e.target.value.trim();
                    const slotType = getSlotTypeFromContainer(slotContainer);
                    updateSlotDisplay(slotContainer, newId, slotType);

                    if (slotType === 'Bag' && slotContainer.id.includes('-type-slot')) {
                        const bagKey = slotContainer.id.slice(0, 4);
                        populateBagUI(bagKey, readBagFromUI(bagKey));
                    }
                }
            }
        }, true);
        
        document.addEventListener('keydown', (e) => {
            if (e.key === "Escape") {
                deselectActiveSlot();
            }
        });

        document.getElementById('fileInput').addEventListener('change', function(event) {
            const file = event.target.files[0];
            const errorEl = document.getElementById('error');
            const inputJsonEl = document.getElementById('inputJson');
            if (!file) return;
            const reader = new FileReader();
            reader.onload = function(e) {
                inputJsonEl.value = e.target.result;
                errorEl.textContent = '';
                try { loadSaveData(JSON.parse(e.target.result)); } 
                catch (err) { errorEl.textContent = 'The scroll could not be read. ' + err.message; }
            };
            reader.onerror = () => { errorEl.textContent = 'Error reading the scroll file.'; };
            reader.readAsText(file);
        });
        
        document.getElementById('inputJson').addEventListener('input', function(e) {
            const text = e.target.value.trim();
            if (!text) return;
            try { 
                const data = JSON.parse(text);
                loadSaveData(data); 
            } 
            catch (err) { /* Silently fail on invalid JSON during typing */ }
        });

        document.getElementById('calculateButton').addEventListener('click', () => {
            const inputJsonEl = document.getElementById('inputJson');
            const outputJsonEl = document.getElementById('outputJson');
            const errorEl = document.getElementById('error');
            outputJsonEl.value = '';
            errorEl.textContent = '';
            document.getElementById('exportSection').classList.add('hidden');
            if (inputJsonEl.value.trim() === '') {
                errorEl.textContent = 'The scroll is blank! Inscribe your data first.';
                return;
            }
            try {
                let saveData = JSON.parse(inputJsonEl.value);
                saveData = applyEdits(saveData);
                saveData.hash = calculateHash(saveData);
                outputJsonEl.value = JSON.stringify(saveData, null, 4);
                document.getElementById('exportSection').classList.remove('hidden');
            } catch (e) {
                errorEl.textContent = 'The inscription is corrupt. ' + e.message;
            }
        });
        
        document.getElementById('exportButton').addEventListener('click', () => {
            const outputJson = document.getElementById('outputJson').value;
            const saveFileName = document.getElementById('saveFileName').value || 'murloc_save';
            const successMsg = document.getElementById('successMsg');
            successMsg.classList.remove('show');
            if (!outputJson) {
                document.getElementById('error').textContent = 'Nothing to export! Re-forge the seal first.';
                return;
            }
            try {
                const blob = new Blob([outputJson], { type: 'text/plain' });
                const a = document.createElement('a');
                a.download = saveFileName + '.sav';
                a.href = window.URL.createObjectURL(blob);
                a.style.display = 'none';
                document.body.appendChild(a);
                a.click();
                window.URL.revokeObjectURL(a.href);
                document.body.removeChild(a);
                successMsg.classList.add('show');
                setTimeout(() => successMsg.classList.remove('show'), 3000);
            } catch (e) {
                document.getElementById('error').textContent = 'Failed to export: ' + e.message;
            }
        });

        // --- ITEM DICTIONARY SCRIPT ---
        const itemListEl = document.getElementById('itemList');
        if(Object.keys(itemDB).length > 0){
            const itemArray = Object.values(itemDB).sort((a, b) => a.name.localeCompare(b.name));
            itemArray.forEach(item => {
                const itemEl = document.createElement('a');
                itemEl.href = '#';
                itemEl.textContent = item.name;
                itemEl.dataset.itemId = item.id;
                itemEl.className = `block p-1 rounded hover:bg-stone-700/50 text-sm truncate cursor-pointer quality-${item.quality}`;
                itemEl.title = item.name;
                itemListEl.appendChild(itemEl);
            });
            initializeFilters();
        }

        function populateFilter(selectEl, optionsSet) {
            const sortedOptions = [...optionsSet].sort((a, b) => a.localeCompare(b));
            sortedOptions.forEach(optionValue => {
                if (optionValue && optionValue !== "none") {
                    const optionEl = document.createElement('option');
                    optionEl.value = optionValue;
                    optionEl.textContent = optionValue.charAt(0).toUpperCase() + optionValue.slice(1);
                    selectEl.appendChild(optionEl);
                }
            });
        }

        function initializeFilters() {
            // Populate dynamic filter sets from item DB
            for (const key in itemDB) {
                const item = itemDB[key];
                if (item.type) filterValueSets.types.add(item.type);
                if (item.loc && item.loc !== 'none') filterValueSets.locs.add(item.loc);
                if (item.mat && item.mat !== 'none') filterValueSets.mats.add(item.mat);
            }

            // --- Manually populate Quality Filter with specific order and colors ---
            const filterQualityEl = document.getElementById('filterQuality');
            while (filterQualityEl.options.length > 1) { // Clear any pre-existing options
                filterQualityEl.remove(1);
            }
            filterValueSets.qualities.forEach(quality => {
                const optionEl = document.createElement('option');
                optionEl.value = quality;
                optionEl.textContent = quality.charAt(0).toUpperCase() + quality.slice(1);
                optionEl.className = `quality-${quality}`; // Apply color class
                filterQualityEl.appendChild(optionEl);
            });

            // --- Populate other filters dynamically ---
            populateFilter(document.getElementById('filterType'), filterValueSets.types);
            populateFilter(document.getElementById('filterLoc'), filterValueSets.locs);
            populateFilter(document.getElementById('filterMat'), filterValueSets.mats);

            // --- Add event listeners ---
            document.querySelectorAll('#itemSearch, .filter-select').forEach(el => {
                const eventType = el.tagName === 'SELECT' ? 'change' : 'input';
                el.addEventListener(eventType, applyFilters);
            });

            // Add listener to change the select box color on selection
            filterQualityEl.addEventListener('change', (e) => {
                e.target.className = e.target.className.replace(/\s?quality-\w+/g, '');
                const selectedOption = e.target.options[e.target.selectedIndex];
                if (selectedOption.className) {
                    e.target.classList.add(selectedOption.className);
                }
            });
        }

        function applyFilters() {
            const searchTerm = document.getElementById('itemSearch').value.toLowerCase().trim();
            const selectedQuality = document.getElementById('filterQuality').value;
            const selectedType = document.getElementById('filterType').value;
            const selectedLoc = document.getElementById('filterLoc').value;
            const selectedMat = document.getElementById('filterMat').value;

            // Split search term by spaces or commas
            const searchKeywords = searchTerm.split(/[ ,]+/).filter(k => k);

            // Categorize keywords from the search input
            const nameSearchTerms = [];
            const qualitySearchTerms = [];
            const typeSearchTerms = [];
            const locSearchTerms = [];
            const matSearchTerms = [];

            searchKeywords.forEach(keyword => {
                if (filterValueSets.qualities.includes(keyword)) {
                    qualitySearchTerms.push(keyword);
                } else if (filterValueSets.types.has(keyword)) {
                    typeSearchTerms.push(keyword);
                } else if (filterValueSets.locs.has(keyword)) {
                    locSearchTerms.push(keyword);
                } else if (filterValueSets.mats.has(keyword)) {
                    matSearchTerms.push(keyword);
                } else {
                    nameSearchTerms.push(keyword);
                }
            });

            const itemLinks = itemListEl.getElementsByTagName('a');

            for (const itemLink of itemLinks) {
                const itemId = itemLink.dataset.itemId;
                const itemData = getItem(itemId);

                if (!itemData) {
                    itemLink.style.display = 'none';
                    continue;
                }

                const itemLoc = itemData.loc || 'none';
                const itemMat = itemData.mat || 'none';

                // --- Match against dropdowns first ---
                const dropdownQualityMatch = selectedQuality === 'all' || itemData.quality === selectedQuality;
                const dropdownTypeMatch = selectedType === 'all' || itemData.type === selectedType;
                const dropdownLocMatch = selectedLoc === 'all' || itemLoc === selectedLoc;
                const dropdownMatMatch = selectedMat === 'all' || itemMat === selectedMat;

                // --- Then match against search keywords ---
                // 'every' ensures all name terms must match. 'includes' checks if the item's property is in the list of search terms.
                const nameMatch = nameSearchTerms.every(term => itemData.name.toLowerCase().includes(term));
                const searchQualityMatch = qualitySearchTerms.length === 0 || qualitySearchTerms.includes(itemData.quality);
                const searchTypeMatch = typeSearchTerms.length === 0 || typeSearchTerms.includes(itemData.type);
                const searchLocMatch = locSearchTerms.length === 0 || locSearchTerms.includes(itemLoc);
                const searchMatMatch = matSearchTerms.length === 0 || matSearchTerms.includes(itemMat);

                // An item is shown only if it matches ALL filter criteria
                if (dropdownQualityMatch && dropdownTypeMatch && dropdownLocMatch && dropdownMatMatch &&
                    nameMatch && searchQualityMatch && searchTypeMatch && searchLocMatch && searchMatMatch) {
                    itemLink.style.display = 'block';
                } else {
                    itemLink.style.display = 'none';
                }
            }
        }

        // --- ITEM CODEX EVENT LISTENERS ---
        itemListEl.addEventListener('click', (e) => {
            const target = e.target.closest('a');
            if (target && target.dataset.itemId) {
                e.preventDefault();
                if (activeSlotDisplay) {
                    const newItemId = target.dataset.itemId;
                    const newItem = getItem(newItemId);
                    
                    const slotContainer = activeSlotDisplay.closest('.item-slot-container');
                    if (!slotContainer) { 
                        deselectActiveSlot();
                        return; 
                    }

                    const slotType = getSlotTypeFromContainer(slotContainer);
                    const isBagTypeSlot = slotType === 'Bag' && slotContainer.id.includes('-type-slot');

                    if (isBagTypeSlot) {
                        if (newItem.type !== 'bag') {
                            alert('You can only place bags in this slot.');
                            deselectActiveSlot();
                            return;
                        }
                        
                        // Get current bag information
                        const bagKey = slotContainer.id.slice(0, 4);
                        const currentBagData = readBagFromUI(bagKey);
                        const oldBagItemId = currentBagData[0];
                        const oldBagSlotCount = getBagSlotCount(oldBagItemId);
                        const newBagSlotCount = newItem.slots || 0;
                        
                        // Check if switching to a smaller bag and if there are items that would be lost
                        if (newBagSlotCount < oldBagSlotCount && oldBagSlotCount > 0) {
                            // Check if there are items in slots that would be lost
                            const currentBagSlots = currentBagData.slice(1); // Remove bag item, keep only slot data
                            let hasItemsToLose = false;
                            
                            // Check slots beyond the new bag's capacity
                            for (let i = newBagSlotCount; i < currentBagSlots.length; i++) {
                                const slotData = currentBagSlots[i];
                                if (slotData && slotData[0] && slotData[0] !== "empty") {
                                    hasItemsToLose = true;
                                    break;
                                }
                            }
                            
                            if (hasItemsToLose) {
                                const newBagName = newItem.name || newItemId;
                                const slotsToLose = oldBagSlotCount - newBagSlotCount;
                                const message = `Switching to ${newBagName} (${newBagSlotCount} slots) will lose items in ${slotsToLose} slot(s). Items in slots ${newBagSlotCount + 1} to ${oldBagSlotCount} will be lost. Continue?`;
                                
                                if (!confirm(message)) {
                                    deselectActiveSlot();
                                    return;
                                }
                            }
                        }
                        
                        // Proceed with the bag change
                        updateSlotDisplay(slotContainer, newItemId);
                        populateBagUI(bagKey, readBagFromUI(bagKey));
                    } else {
                        updateSlotDisplay(slotContainer, newItemId, slotType);
                    }
                    deselectActiveSlot();
                } else {
                     navigator.clipboard.writeText(target.dataset.itemId).then(() => {
                        const originalText = target.title;
                        target.textContent = 'Copied!';
                        target.classList.add('text-green-400');
                        setTimeout(() => {
                            target.textContent = originalText;
                            target.classList.remove('text-green-400');
                        }, 1500);
                    });
                }
            }
        });

        itemListEl.addEventListener('mouseover', e => {
            const target = e.target.closest('a');
            if (target && target.dataset.itemId) {
                showTooltip(target.dataset.itemId, e);
            }
        });

        itemListEl.addEventListener('mouseout', e => {
            const target = e.target.closest('a');
            if (target && target.dataset.itemId) {
                hideTooltip();
            }
        });

        itemListEl.addEventListener('mousemove', e => {
            const tooltip = document.getElementById('tooltip');
            if (!tooltip.classList.contains('hidden')) {
                tooltip.style.left = `${e.pageX + 15}px`;
                tooltip.style.top = `${e.pageY + 15}px`;
            }
        });
    </script>
</body>
</html>
